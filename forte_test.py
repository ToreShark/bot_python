import re, json, os
from pymongo import MongoClient
from bson import ObjectId
from dotenv import load_dotenv
load_dotenv()


MONGO_ID = "68285ab16520c18e1a4a7b28"  # â† Ğ²Ğ°Ñˆ ID

# â”€â”€ ĞĞ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ‚ĞµĞºÑÑ‚Ğ° Ğ´Ğ»Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ñ‹ Ğ¾Ñ‚ OCR Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def normalize(text: str) -> str:
    """Ğ—Ğ°Ğ¼ĞµĞ½ÑĞµÑ‚ OCR-Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ¸ ÑƒĞ½Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€ÑƒĞµÑ‚ ĞºĞ°Ğ²Ñ‹Ñ‡ĞºĞ¸"""
    replacements = {
        "Ğ’": "B", "Ğ²": "b",  # ĞºĞ¸Ñ€Ğ¸Ğ»Ğ»Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ’ â†’ Ğ»Ğ°Ñ‚Ğ¸Ğ½ÑĞºĞ°Ñ B
        "Ğ": "O", "Ğ¾": "o",  # ĞºĞ¸Ñ€Ğ¸Ğ»Ğ»Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ â†’ Ğ»Ğ°Ñ‚Ğ¸Ğ½ÑĞºĞ°Ñ O
        "Â«": "\"", "Â»": "\"",  # ĞºĞ°Ğ²Ñ‹Ñ‡ĞºĞ¸
    }
    for cyrillic, latin in replacements.items():
        text = text.replace(cyrillic, latin)
    return text


# â”€â”€ ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº MongoDB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
cli = MongoClient(os.getenv("MONGO_URI"))
doc = cli["telegram_bot"].documents.find_one(
    {"_id": ObjectId(MONGO_ID)}, {"text": 1, "_id": 0})

if not doc or "text" not in doc:
    raise SystemExit("âŒ Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ¸Ğ»Ğ¸ Ğ½ĞµÑ‚ Ğ¿Ğ¾Ğ»Ñ text")

txt = normalize(doc["text"])  # Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·ÑƒĞµĞ¼ Ñ‚ĞµĞºÑÑ‚

# â”€â”€ ĞŸĞ¾Ğ¸ÑĞº Ğ±Ğ»Ğ¾ĞºĞ° Ğ¿Ğ¾ Ñ€ĞµĞ³ÑƒĞ»ÑÑ€ĞºĞµ Ñ Ğ³Ğ¸Ğ±ĞºĞ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¾Ğ¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
m = re.search(
    r"(Ğ—Ğ°Ğ¹Ğ¼|ĞšÑ€ĞµĞ´Ğ¸Ñ‚Ğ½Ğ°Ñ ĞºĞ°Ñ€Ñ‚Ğ°|ĞšÑ€ĞµĞ´Ğ¸Ñ‚Ğ½Ğ°Ñ Ğ»Ğ¸Ğ½Ğ¸Ñ)[^\n]*?\n\s*ĞĞ\s*[\"']?\s*F[oĞ¾]rte[BĞ’]ank\s*[\"']?",
    txt, re.I
)

if not m:
    print("âš ï¸  ForteBank Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ğ¾Ğ¹ Ñ€ĞµĞ³ÑƒĞ»ÑÑ€ĞºĞ¾Ğ¹, Ğ¿Ñ€Ğ¾Ğ±ÑƒÑ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑâ€¦")
    # ĞĞ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ¸ÑĞº Ñ‡ĞµÑ€ĞµĞ· Ñ€Ğ°Ğ·Ğ±Ğ¸ĞµĞ½Ğ¸Ğµ Ğ½Ğ° Ğ±Ğ»Ğ¾ĞºĞ¸
    for block in txt.split("Ğ—Ğ°Ğ¹Ğ¼"):
        if "RBK" in block:
            print("âœ… ĞĞ°Ğ¹Ğ´ĞµĞ½ Ğ±Ğ»Ğ¾Ğº ForteBank Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ!")
            txt = "Ğ—Ğ°Ğ¹Ğ¼" + block  # Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº Ğ±Ğ»Ğ¾ĞºĞ°
            break
    else:
        raise SystemExit("âŒ Ğ‘Ğ»Ğ¾Ğº ForteBank Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ â€” Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑŒ Ğ¾Ñ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚.")

else:
    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ²ĞµÑÑŒ Ğ±Ğ»Ğ¾Ğº, Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°Ñ Ñ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ñ
    start = m.start()
    following = txt[start:]
    next_match = re.search(r"\n(Ğ—Ğ°Ğ¹Ğ¼|ĞšÑ€ĞµĞ´Ğ¸Ñ‚Ğ½Ğ°Ñ ĞºĞ°Ñ€Ñ‚Ğ°|ĞšÑ€ĞµĞ´Ğ¸Ñ‚Ğ½Ğ°Ñ Ğ»Ğ¸Ğ½Ğ¸Ñ)\b", following[10:])
    end = start + (next_match.start() + 10 if next_match else len(following))
    txt = txt[start:end]  # Ñ‚ĞµĞ¿ĞµÑ€ÑŒ txt â€” Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ±Ğ»Ğ¾Ğº ForteBank

# â”€â”€ ĞŸĞ°Ñ€ÑĞ¸Ğ½Ğ³ Ñ‡Ğ¸ÑĞµĞ» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def num(s: str) -> float:
    return float(re.sub(r"[^\d,\.]", "", s).replace(",", ".").replace(" ", "")) if s else 0.0

def find(pattern, text, default="0"):
    m = re.search(pattern, text, re.I)
    return m.group(1) if m else default

# â”€â”€ Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Ğ±Ğ»Ğ¾ĞºĞ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ” ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ±Ğ»Ğ¾Ğº ForteBank Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ
print("===== Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ Ğ±Ğ»Ğ¾ĞºĞ° ForteBank =====")
print(txt)
print("===== ĞšĞ¾Ğ½ĞµÑ† Ğ±Ğ»Ğ¾ĞºĞ° =====")

# â”€â”€ Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Ğ±Ğ»Ğ¾ĞºĞ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ğ˜Ñ‰ĞµĞ¼ Ğ²ÑĞµ ÑÑƒĞ¼Ğ¼Ñ‹ Ñ KZT
# ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ²ÑĞµ ÑÑ‚Ñ€Ğ¾ĞºĞ¸, Ğ³Ğ´Ğµ ĞµÑÑ‚ÑŒ "KZT" â€” Ğ´Ğ°Ğ¶Ğµ ĞµÑĞ»Ğ¸ Ğ½Ğ° Ğ½Ğ¾Ğ²Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ¾ĞºĞµ
lines = txt.splitlines()
amounts = [line.strip() for line in lines if "KZT" in line]


# Ğ˜Ñ‰ĞµĞ¼ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾ Ğ²ÑĞµ Ñ‡Ğ¸ÑĞ»Ğ° Ğ±ĞµĞ· Ğ±ÑƒĞºĞ² (Ğ´Ğ»Ñ Ğ´Ğ½ĞµĞ¹ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºĞ¸)
all_numbers = re.findall(r"\b\d{1,3}\b", txt)  # Ñ‡Ğ¸ÑĞ»Ğ° Ğ´Ğ¾ 3 Ñ†Ğ¸Ñ„Ñ€, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ Ğ·Ğ°Ñ…Ğ²Ğ°Ñ‚Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ´Ğ°Ñ‚Ñ‹

# Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ğ½ÑƒĞ¶Ğ½Ñ‹Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ
contract_amount = num(amounts[0]) if len(amounts) > 0 else 0.0
balance = num(amounts[1]) if len(amounts) > 1 else 0.0
overdue_amount = num(amounts[2]) if len(amounts) > 2 else 0.0
overdue_days = int(all_numbers[3]) if len(all_numbers) > 3 else 0  # Ğ¿Ğ¾ÑĞ»Ğµ Ğ´Ğ°Ñ‚Ñ‹ Ğ¸ ÑÑƒĞ¼Ğ¼

# ğŸ‘‡ Ğ”ĞĞ‘ĞĞ’Ğ¬ Ğ­Ğ¢Ğ!
data = {
    "creditor": "ĞĞ Â«ForteBankÂ»",
    "financing_type": find(r"(Ğ—Ğ°Ğ¹Ğ¼|ĞšÑ€ĞµĞ´Ğ¸Ñ‚Ğ½Ğ°Ñ ĞºĞ°Ñ€Ñ‚Ğ°|ĞšÑ€ĞµĞ´Ğ¸Ñ‚Ğ½Ğ°Ñ Ğ»Ğ¸Ğ½Ğ¸Ñ)", txt),
    "contract_amount": contract_amount,
    "balance": balance,
    "overdue_amount": overdue_amount,
    "overdue_days": overdue_days
}


# â”€â”€ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¸ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ¸Ğ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
print(json.dumps(data, indent=2, ensure_ascii=False))

with open("forte_test.json", "w", encoding="utf-8") as f:
    json.dump(data, f, indent=2, ensure_ascii=False)

print("âœ…  Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ ForteBank ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ñ‹ Ğ² forte_test.json")
